{% extends "base.html" %}

{% block title %}{{ project_id }} - AI Factory Manager{% endblock %}

{% block content %}
<!-- Back button -->
<div class="mb-4">
    <a href="{{ url_for('index') }}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
        â† Dashboard'a DÃ¶n
    </a>
</div>

<!-- Project Header -->
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="flex justify-between items-start">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">{{ project_id }}</h1>
            <p class="mt-1 text-sm text-gray-500">{{ state.meta.repo_url }}</p>
        </div>
        <div class="flex items-center space-x-2">
            <a href="{{ url_for('prp_page', project_id=project_id) }}"
               class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-medium">
                ğŸ“„ View PRP
            </a>
            <a href="{{ url_for('validation_history', project_id=project_id) }}" 
               class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm font-medium">
                ğŸ“œ Validation History
            </a>
            <span class="phase-indicator phase-{{ state.phase }}">
                {{ state.phase }}
            </span>
        </div>
    </div>

    <!-- Phase Progress -->
    <div class="mt-6">
        <div class="flex items-center space-x-2">
            {% set phases = ['idea', 'prp', 'development', 'test', 'human_validation', 'release'] %}
            {% for phase in phases %}
                {% if loop.index0 < phases.index(state.phase) %}
                    <div class="flex-1 h-2 bg-green-500 rounded"></div>
                {% elif phase == state.phase %}
                    <div class="flex-1 h-2 bg-blue-500 rounded"></div>
                {% else %}
                    <div class="flex-1 h-2 bg-gray-200 rounded"></div>
                {% endif %}
            {% endfor %}
        </div>
        <div class="flex justify-between mt-2 text-xs text-gray-500">
            {% for phase in phases %}
                <span>{{ phase }}</span>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Agent Actions -->
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Agent Ä°ÅŸlemleri</h2>

    {% set phase = state.phase %}
    {% set next_agent = state.next_action.agent %}
    {% set requires_approval = state.next_action.requires_human_approval %}

    <div class="space-y-4">
        <!-- Model Selection Section -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
                <h3 class="font-medium text-blue-900">ğŸ”§ Model Selection</h3>
                <button id="toggleModelSelect" onclick="toggleModelDropdowns()" 
                        class="text-xs bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded">
                    Show/Hide
                </button>
            </div>
            <p class="text-xs text-blue-700 mb-3" id="modelHelp">
                Select different models for each agent. Leave empty to use project defaults.
            </p>
            
            <div id="modelDropdowns" class="grid grid-cols-2 md:grid-cols-4 gap-3" style="display:none">
                <!-- PRP Model -->
                <div>
                    <label class="text-xs text-gray-600 block mb-1">PRP Agent</label>
                    <select id="model-prp" class="w-full text-xs border rounded p-1.5 bg-white">
                        <option value="">Default (from state)</option>
                    </select>
                </div>
                <!-- Dev Model -->
                <div>
                    <label class="text-xs text-gray-600 block mb-1">Dev Agent</label>
                    <select id="model-dev" class="w-full text-xs border rounded p-1.5 bg-white">
                        <option value="">Default (from state)</option>
                    </select>
                </div>
                <!-- Test Model -->
                <div>
                    <label class="text-xs text-gray-600 block mb-1">Test Agent</label>
                    <select id="model-test" class="w-full text-xs border rounded p-1.5 bg-white">
                        <option value="">Default (from state)</option>
                    </select>
                </div>
                <!-- Doc Model -->
                <div>
                    <label class="text-xs text-gray-600 block mb-1">Doc Agent</label>
                    <select id="model-doc" class="w-full text-xs border rounded p-1.5 bg-white">
                        <option value="">Default (from state)</option>
                    </select>
                </div>
            </div>
            
            <!-- Save/Reset Buttons -->
            <div class="mt-4 flex gap-2" id="modelButtons" style="display:none">
                <button onclick="showSaveModelsModal()" 
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-medium">
                    ğŸ’¾ Save as Default
                </button>
                <button onclick="resetModelSelections()" 
                        class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm font-medium">
                    ğŸ”„ Reset to Defaults
                </button>
            </div>
        </div>

        <!-- Agent Buttons -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <!-- PRP Agent -->
            {% set prp_enabled = phase in ['idea', 'prp'] %}
            <button onclick="{% if prp_enabled %}runAgent('prp'){% endif %}"
                    class="px-4 py-3 rounded-lg font-medium text-sm transition
                           {% if prp_enabled %}bg-blue-50 hover:bg-blue-100 text-blue-700 cursor-pointer{% else %}bg-gray-100 text-gray-400 cursor-not-allowed{% endif %}
                           {% if next_agent == 'prp_agent' and requires_approval %}ring-2 ring-orange-400{% endif %}"
                    {% if not prp_enabled %}disabled{% endif %}>
                ğŸ¯ PRP Agent
                {% if next_agent == 'prp_agent' and requires_approval %}<span class="text-xs block">âš ï¸</span>{% endif %}
            </button>
            
            <!-- Dev Agent -->
            {% set dev_enabled = phase == 'development' %}
            <button onclick="{% if dev_enabled %}runAgent('dev'){% endif %}"
                    class="px-4 py-3 rounded-lg font-medium text-sm transition
                           {% if dev_enabled %}bg-yellow-50 hover:bg-yellow-100 text-yellow-700 cursor-pointer{% else %}bg-gray-100 text-gray-400 cursor-not-allowed{% endif %}
                           {% if next_agent == 'dev_agent' and requires_approval %}ring-2 ring-orange-400{% endif %}"
                    {% if not dev_enabled %}disabled{% endif %}>
                ğŸ’» Dev Agent
                {% if next_agent == 'dev_agent' and requires_approval %}<span class="text-xs block">âš ï¸</span>{% endif %}
            </button>
            
            <!-- Test Agent -->
            {% set test_enabled = phase == 'test' %}
            <button onclick="{% if test_enabled %}runAgent('test'){% endif %}"
                    class="px-4 py-3 rounded-lg font-medium text-sm transition
                           {% if test_enabled %}bg-orange-50 hover:bg-orange-100 text-orange-700 cursor-pointer{% else %}bg-gray-100 text-gray-400 cursor-not-allowed{% endif %}
                           {% if next_agent == 'test_agent' and requires_approval %}ring-2 ring-orange-400{% endif %}"
                    {% if not test_enabled %}disabled{% endif %}>
                ğŸ§ª Test Agent
                {% if next_agent == 'test_agent' and requires_approval %}<span class="text-xs block">âš ï¸</span>{% endif %}
            </button>
            
            <!-- Doc Agent -->
            {% set doc_enabled = phase in ['test', 'release'] %}
            <button onclick="{% if doc_enabled %}runAgent('doc'){% endif %}"
                    class="px-4 py-3 rounded-lg font-medium text-sm transition
                           {% if doc_enabled %}bg-purple-50 hover:bg-purple-100 text-purple-700 cursor-pointer{% else %}bg-gray-100 text-gray-400 cursor-not-allowed{% endif %}"
                    {% if not doc_enabled %}disabled{% endif %}>
                ğŸ“„ Doc Agent
            </button>
        </div>
    </div>

    <!-- Phase Info -->
    <!-- Vision Input (only for idea phase) -->
    {% if state.phase == 'idea' %}
    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg shadow-sm p-6 mb-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“ Product Vision</h3>
        <p class="text-sm text-gray-600 mb-3">
        Describe your product vision. The PRP Agent will use this to generate detailed requirements.
        </p>
        <textarea id="visionInput" rows="8" 
              class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Example: A command-line tool that helps developers manage their projects..."></textarea>
        <div class="flex items-center justify-between mt-3">
            <button id="saveVisionBtn"
                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">
            ğŸ’¾ Save Vision
            </button>
            <span id="visionStatus" class="text-sm text-gray-500"></span>
        </div>
    </div>
    {% endif %}

    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
        <p class="text-sm text-blue-800">
            {% if phase == 'idea' %}
                ğŸ“Œ Proje idea fazÄ±nda. PRP Agent'Ä± Ã§alÄ±ÅŸtÄ±rarak PRP oluÅŸturun.
            {% elif phase == 'prp' %}
                ğŸ“Œ PRP hazÄ±r. Development fazÄ±na geÃ§mek iÃ§in state'i gÃ¼ncelleyin.
            {% elif phase == 'development' %}
                ğŸ“Œ Development fazÄ±nda. Dev Agent'Ä± Ã§alÄ±ÅŸtÄ±rarak kod Ã¼retin.
            {% elif phase == 'test' %}
                ğŸ“Œ Test fazÄ±nda. Test Agent'Ä± Ã§alÄ±ÅŸtÄ±rarak testleri yÃ¼rÃ¼tÃ¼n.
            {% elif phase == 'human_validation' %}
                âš ï¸ Ä°nsan validasyonu bekleniyor.
                <a href="{{ url_for('human_validation', project_id=project_id) }}" class="font-semibold underline">
                    Validation sayfasÄ±na git â†’
                </a>
            {% elif phase == 'release' %}
                âœ… Proje release fazÄ±nda. Ä°steÄŸe baÄŸlÄ± Doc Agent ile dokÃ¼mantasyon gÃ¼ncelleyin.
            {% endif %}
        </p>
    </div>

    <div id="agent-output" class="mt-4 hidden">
        <div class="bg-gray-50 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-gray-700">Agent Ã‡Ä±ktÄ±sÄ±</h3>
                <button onclick="document.getElementById('agent-output').classList.add('hidden')"
                        class="text-gray-400 hover:text-gray-600">
                    âœ•
                </button>
            </div>
            <div id="loading" class="hidden">
                <div class="animate-pulse text-sm text-gray-600">Agent Ã§alÄ±ÅŸÄ±yor...</div>
            </div>
            <pre id="agent-output-content" class="text-xs text-gray-600 whitespace-pre-wrap max-h-96 overflow-y-auto"></pre>
        </div>
    </div>
</div>

<!-- State Info -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Versions -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Versiyonlar</h2>
        <dl class="space-y-2">
            <div class="flex justify-between">
                <dt class="text-sm text-gray-600">PRP:</dt>
                <dd class="text-sm font-medium text-gray-900">v{{ state.version.prp }}</dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-sm text-gray-600">Code:</dt>
                <dd class="text-sm font-medium text-gray-900">v{{ state.version.code }}</dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-sm text-gray-600">Docs:</dt>
                <dd class="text-sm font-medium text-gray-900">v{{ state.version.docs }}</dd>
            </div>
        </dl>
    </div>

    <!-- Blocking Status -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Durum</h2>
        {% if state.blocking.is_blocked %}
            <div class="bg-red-50 rounded-lg p-4">
                <p class="text-sm font-medium text-red-800">ğŸš« Blocked</p>
                <p class="text-sm text-red-600 mt-1">{{ state.blocking.reason }}</p>
                {% if state.blocking.since %}
                    <p class="text-xs text-red-500 mt-1">Since: {{ state.blocking.since }}</p>
                {% endif %}
            </div>
        {% else %}
            <div class="bg-green-50 rounded-lg p-4">
                <p class="text-sm font-medium text-green-800">âœ… Active</p>
                <p class="text-sm text-green-600 mt-1">Proje aktif ve Ã§alÄ±ÅŸÄ±yor</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Next Action -->
<div class="bg-white rounded-lg shadow p-6 mt-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Sonraki AdÄ±m</h2>
    <div class="bg-blue-50 rounded-lg p-4">
        <p class="text-sm font-medium text-blue-900">{{ state.next_action.agent }}</p>
        <p class="text-sm text-blue-700 mt-1">{{ state.next_action.action }}</p>
        {% if state.next_action.requires_human_approval %}
            <p class="text-xs text-orange-600 mt-2">âš ï¸ Ä°nsan onayÄ± gerekiyor</p>
        {% endif %}
    </div>
</div>

<!-- Last Event -->
{% if state.last_event %}
<div class="bg-white rounded-lg shadow p-6 mt-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Son Ä°ÅŸlem</h2>
    <dl class="space-y-2">
        <div class="flex justify-between">
            <dt class="text-sm text-gray-600">Agent:</dt>
            <dd class="text-sm font-medium text-gray-900">{{ state.last_event.agent }}</dd>
        </div>
        <div class="flex justify-between">
            <dt class="text-sm text-gray-600">Action:</dt>
            <dd class="text-sm font-medium text-gray-900">{{ state.last_event.action }}</dd>
        </div>
        <div class="flex justify-between">
            <dt class="text-sm text-gray-600">Result:</dt>
            <dd class="text-sm font-medium {{ 'text-green-600' if state.last_event.result == 'success' else 'text-red-600' }}">
                {{ state.last_event.result }}
            </dd>
        </div>
        {% if state.last_event.model %}
        <div class="flex justify-between">
            <dt class="text-sm text-gray-600">Model:</dt>
            <dd class="text-sm font-medium text-gray-900">{{ state.last_event.model }}</dd>
        </div>
        {% endif %}
        <div class="flex justify-between">
            <dt class="text-sm text-gray-600">Timestamp:</dt>
            <dd class="text-sm font-medium text-gray-900">{{ state.last_event.timestamp }}</dd>
        </div>
    </dl>
</div>
{% endif %}

<!-- Modals -->

<!-- Save Models Confirmation Modal -->
<div id="saveModelsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="p-6">
            <h3 class="text-xl font-bold mb-4">ğŸ’¾ Save Model Defaults</h3>
            <p class="text-gray-700 mb-4">
                Save current model selections as default for this project?
            </p>
            
            <div class="bg-gray-50 p-4 rounded mb-4 text-sm">
                <div class="grid grid-cols-2 gap-2">
                    <div class="font-semibold">PRP Agent:</div>
                    <div id="save-prp-model" class="text-gray-600"></div>
                    
                    <div class="font-semibold">Dev Agent:</div>
                    <div id="save-dev-model" class="text-gray-600"></div>
                    
                    <div class="font-semibold">Test Agent:</div>
                    <div id="save-test-model" class="text-gray-600"></div>
                    
                    <div class="font-semibold">Doc Agent:</div>
                    <div id="save-doc-model" class="text-gray-600"></div>
                </div>
            </div>
            
            <div id="save-models-error" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded text-sm"></div>
            
            <div class="flex gap-2">
                <button onclick="confirmSaveModels()" 
                        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Confirm
                </button>
                <button onclick="closeSaveModelsModal()" 
                        class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Agent Error Modal -->
<div id="agentErrorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4">
        <div class="p-6">
            <div class="flex items-start mb-4">
                <div class="flex-shrink-0">
                    <span class="text-4xl">âŒ</span>
                </div>
                <div class="ml-4 flex-1">
                    <h3 class="text-xl font-bold text-red-800">Agent Error</h3>
                    <p class="text-sm text-gray-600 mt-1">The agent encountered an error while running.</p>
                </div>
            </div>
            
            <div class="bg-red-50 border border-red-200 rounded p-4 mb-4">
                <p id="error-message" class="text-sm text-red-900 whitespace-pre-wrap"></p>
            </div>
            
            <div class="flex justify-end">
                <button onclick="closeErrorModal()" 
                        class="px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>

const projectId = "{{ project_id }}";
 
// Model dropdown toggle
function toggleModelDropdowns() {
    const dropdowns = document.getElementById('modelDropdowns');
    const buttons = document.getElementById('modelButtons');
    if (dropdowns.style.display === 'none') {
        dropdowns.style.display = 'grid';
        buttons.style.display = 'flex';
    } else {
        dropdowns.style.display = 'none';
        buttons.style.display = 'none';
    }
}

// Load available profiles on page load
async function loadProfiles() {
    try {
        const response = await fetch('/api/get-profiles');
        const data = await response.json();
        
        if (data.success) {
            const profiles = data.profiles;
            const selects = ['prp', 'dev', 'test', 'doc'];
            
            // State'teki mevcut deÄŸerleri al
            const stateModels = {
                prp: '{{ state.agent_models.prp_agent if state.agent_models else "" }}',
                dev: '{{ state.agent_models.dev_agent if state.agent_models else "" }}',
                test: '{{ state.agent_models.test_agent if state.agent_models else "" }}',
                doc: '{{ state.agent_models.doc_agent if state.agent_models else "" }}'
            };
            
            selects.forEach(agent => {
                const select = document.getElementById(`model-${agent}`);
                if (select) {
                    profiles.forEach(profile => {
                        const option = document.createElement('option');
                        option.value = profile.name;
                        option.textContent = `${profile.name}`;
                        if (profile.description) {
                            option.title = profile.description;
                        }
                        select.appendChild(option);
                    });
                    
                    // State'teki deÄŸeri seÃ§
                    if (stateModels[agent]) {
                        select.value = stateModels[agent];
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error loading profiles:', error);
    }
}

// Save Models Modal Functions
function showSaveModelsModal() {
    const prpModel = document.getElementById('model-prp').value;
    const devModel = document.getElementById('model-dev').value;
    const testModel = document.getElementById('model-test').value;
    const docModel = document.getElementById('model-doc').value;
    
    document.getElementById('save-prp-model').textContent = prpModel || 'Default (from state)';
    document.getElementById('save-dev-model').textContent = devModel || 'Default (from state)';
    document.getElementById('save-test-model').textContent = testModel || 'Default (from state)';
    document.getElementById('save-doc-model').textContent = docModel || 'Default (from state)';
    
    document.getElementById('saveModelsModal').classList.remove('hidden');
}

function closeSaveModelsModal() {
    document.getElementById('saveModelsModal').classList.add('hidden');
    document.getElementById('save-models-error').classList.add('hidden');
}

async function confirmSaveModels() {
    const prpModel = document.getElementById('model-prp').value;
    const devModel = document.getElementById('model-dev').value;
    const testModel = document.getElementById('model-test').value;
    const docModel = document.getElementById('model-doc').value;
    
    const agentModels = {};
    
    if (prpModel) agentModels.prp_agent = prpModel;
    if (devModel) agentModels.dev_agent = devModel;
    if (testModel) agentModels.test_agent = testModel;
    if (docModel) agentModels.doc_agent = docModel;
    
    try {
        const response = await fetch(`/api/save-agent-models/{{ project_id }}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({agent_models: agentModels})
        });
        
        const data = await response.json();
        
        if (data.success) {
            closeSaveModelsModal();
            alert('âœ… Model defaults saved successfully!');
            location.reload();
        } else {
            document.getElementById('save-models-error').textContent = data.error;
            document.getElementById('save-models-error').classList.remove('hidden');
        }
    } catch (error) {
        document.getElementById('save-models-error').textContent = 'Network error: ' + error.message;
        document.getElementById('save-models-error').classList.remove('hidden');
    }
}

function resetModelSelections() {
    document.getElementById('model-prp').value = '';
    document.getElementById('model-dev').value = '';
    document.getElementById('model-test').value = '';
    document.getElementById('model-doc').value = '';
}

// Error Modal Functions
function showErrorModal(errorMessage) {
    document.getElementById('error-message').textContent = errorMessage;
    document.getElementById('agentErrorModal').classList.remove('hidden');
}

function closeErrorModal() {
    document.getElementById('agentErrorModal').classList.add('hidden');
}

// Run agent with model selection
async function runAgent(agentType) {
    const modelSelect = document.getElementById(`model-${agentType}`);
    const modelOverride = modelSelect ? modelSelect.value : '';
    
    const outputDiv = document.getElementById('agent-output');
    const outputContent = document.getElementById('agent-output-content');
    const loadingDiv = document.getElementById('loading');
    
    outputDiv.classList.remove('hidden');
    loadingDiv.classList.remove('hidden');
    outputContent.textContent = '';
    outputContent.classList.remove('text-red-600');
    
    try {
        const payload = {
            project_id: '{{ project_id }}',
            agent: agentType
        };
        
        if (modelOverride) {
            payload.model_override = modelOverride;
        }
        
        const response = await fetch('/api/run-agent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        loadingDiv.classList.add('hidden');
        
        if (data.success) {
            outputContent.textContent = data.output || 'Agent completed successfully';
            setTimeout(() => location.reload(), 3000);
        } else {
            // Show error modal instead of inline
            showErrorModal(data.error || 'Unknown error');
            outputContent.textContent = 'Error: ' + (data.error || 'Unknown error');
            outputContent.classList.add('text-red-600');
        }
    } catch (error) {
        loadingDiv.classList.add('hidden');
        showErrorModal('Network error: ' + error.message);
        outputContent.textContent = 'Error: ' + error.message;
        outputContent.classList.add('text-red-600');
    }
}

// Error Modal Functions
function showErrorModal(errorMessage) {
    document.getElementById('error-message').textContent = errorMessage;
    document.getElementById('agentErrorModal').classList.remove('hidden');
}

function closeErrorModal() {
    document.getElementById('agentErrorModal').classList.add('hidden');
}

// Run agent with model selection and error modal
async function runAgent(agentType) {
    const modelSelect = document.getElementById(`model-${agentType}`);
    const modelOverride = modelSelect ? modelSelect.value : '';
    
    const outputDiv = document.getElementById('agent-output');
    const outputContent = document.getElementById('agent-output-content');
    const loadingDiv = document.getElementById('loading');
    
    outputDiv.classList.remove('hidden');
    loadingDiv.classList.remove('hidden');
    outputContent.textContent = '';
    outputContent.classList.remove('text-red-600');
    
    try {
        const payload = {
            project_id: '{{ project_id }}',
            agent: agentType
        };
        
        if (modelOverride) {
            payload.model_override = modelOverride;
        }
        
        const response = await fetch('/api/run-agent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        loadingDiv.classList.add('hidden');
        
        if (data.success) {
            outputContent.textContent = data.output || 'Agent completed successfully';
            setTimeout(() => location.reload(), 3000);
        } else {
            // Show error modal instead of inline
            showErrorModal(data.error || 'Unknown error');
            outputContent.textContent = 'Error: ' + (data.error || 'Unknown error');
            outputContent.classList.add('text-red-600');
        }
    } catch (error) {
        loadingDiv.classList.add('hidden');
        showErrorModal('Network error: ' + error.message);
        outputContent.textContent = 'Error: ' + error.message;
        outputContent.classList.add('text-red-600');
    }
}

// Load profiles on page load
document.addEventListener('DOMContentLoaded', loadProfiles);


// Vision Management
async function saveVision() {
    const vision = document.getElementById('visionInput').value.trim();
    const btn = document.getElementById('saveVisionBtn');
    const status = document.getElementById('visionStatus');
    
    if (!vision) {
        status.textContent = 'âš ï¸ Vision cannot be empty';
        status.className = 'text-sm text-red-600';
        return;
    }
    
    btn.disabled = true;
    btn.textContent = 'Saving...';
    status.textContent = '';
    
    try {
        const response = await fetch(`/api/save-vision/${projectId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({vision})
        });
        
        const data = await response.json();
        
        if (data.success) {
            status.textContent = 'âœ… Vision saved! You can now run PRP Agent.';
            status.className = 'text-sm text-green-600';
        } else {
            status.textContent = `âŒ Error: ${data.error}`;
            status.className = 'text-sm text-red-600';
        }
    } catch (error) {
        status.textContent = `âŒ Error: ${error}`;
        status.className = 'text-sm text-red-600';
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ Save Vision';
    }
}

// Load vision on page load
document.addEventListener('DOMContentLoaded', async function() {
    if ('{{ state.phase }}' === 'idea') {
        try {
            const response = await fetch(`/api/get-vision/${projectId}`);
            const data = await response.json();
            if (data.success && data.vision) {
                document.getElementById('visionInput').value = data.vision;
            }
        } catch (error) {
            console.error('Failed to load vision:', error);
        }
    }
});

// Attach event listeners after DOM loads
document.getElementById('saveVisionBtn')?.addEventListener('click', saveVision);

</script>
{% endblock %}
